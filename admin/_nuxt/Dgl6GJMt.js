import{_ as U}from"./CcOBTxZl.js";import{u as D}from"./C8wjtVdh.js";import{d as A,C as F,r as f,D as k,E as b,A as u,q as P,t as _,z as l,B as y,F as n,y as H,G as N,H as C,I as E}from"./DD7AHv1g.js";import{u as O}from"./A5x_le5I.js";import{V as z,a as T,b as h}from"./MCwiuoYB.js";import{V,a as G}from"./Bv0GgKH3.js";import{V as w}from"./DNOu9Y9V.js";import{V as L}from"./hYNdz_3a.js";import{V as Q}from"./ChHQ47om.js";import"./BI7us5jq.js";/* empty css        */import"./BQXSZ5PM.js";import"./JcpH5EyD.js";import"./DWGaNmQL.js";import"./Dgn9K1u6.js";import"./D-Pd036u.js";import"./DI6sJGf3.js";import"./9V3CzVYM.js";const pe=A({__name:"assembly_order",setup(Y){D({title:"Сборка заказа"});const{showError:c,showSuccess:v}=O(),{email:g,password:I}=F(),q=P().public.backendUrl,s=f(null),d=f(""),m=f(1),p=f([]),i=f([]);k(p,()=>{setTimeout(()=>{p.value.length>0&&(p.value=[])},1e3)}),k(i,()=>{setTimeout(()=>{i.value.length>0&&(i.value=[])},1e3)});const x=[{title:"Артикул",key:"good_art"},{title:"Barcode",key:"barcode"},{title:"Название",key:"name"},{title:"Количество",key:"qty"},{title:"Собрано",key:"qty_as"}],$=async o=>{if(o.split("/")[0]!=="002-"||!o.split("/")[1]||o.split("/")[1].length!==6){c("Введите QR-код с листа для сборки");return}const{data:e}=await E(`${q}/order_details.php`,{method:"POST",body:{staff_login:g,staff_password:I,number:o.split("/")[1]}},"$enA4Lu5IYl");e.value.order?(s.value=e.value.order,s.value.goods.forEach(t=>{Number.parseInt(t.qty_as)!==0&&c("Заказ содержит уже отсканированные товары, однако их необходимо отсканировать снова")})):e.value.error&&c(e.value.error)},S=o=>new Promise(e=>setTimeout(e,o)),B=async()=>{let o=!1;if(s.value.goods.forEach(t=>{t.barcode===d.value&&(o=!0)}),!o){p.value=["Лишний товар!"];return}if(Number.parseInt(m.value)<1){i.value=["Количество меньше нуля!"];return}s.value.goods.forEach(t=>{t.barcode===d.value&&(Number.parseInt(t.qty_as)+Number.parseInt(m.value)>Number.parseInt(t.qty)?i.value=["Лишний товар!"]:t.qty_as=Number.parseInt(t.qty_as)+Number.parseInt(m.value))});let e=!0;if(s.value.goods.forEach(t=>{Number.parseInt(t.qty_as)<Number.parseInt(t.qty)&&(e=!1)}),e){v("Заказ собран!");const t=[];s.value.goods.forEach(a=>{t.push({good_art:a.good_art,qty_as:a.qty_as})});const{data:r}=await E(`${q}/order_assembled.php`,{method:"POST",body:{staff_login:g,staff_password:I,order_number:s.value.number,goods:t}},"$9Wv8IUDWpt");if(r.value.message&&v(r.value.message),r.value.error&&v(r.value.error),r.value.html_for_print){const a=window.open("","_blank");a==null||a.document.write(r.value.html_for_print),S(200).then(()=>{a==null||a.document.close(),a==null||a.focus(),a==null||a.print()})}}},R=o=>{if(Number.parseInt(o.item.qty)===Number.parseInt(o.item.qty_as))return{class:"bg-green"}};return(o,e)=>{const t=U;return _(),b(z,null,{default:u(()=>[l(T,null,{default:u(()=>e[6]||(e[6]=[y(" Сборка заказа ")])),_:1}),l(h,null,{default:u(()=>[l(t,{onCodeScanned:$})]),_:1}),n(s)?(_(),b(T,{key:0},{default:u(()=>[y(" №"+H(n(s).number),1)]),_:1})):N("",!0),n(s)?(_(),b(h,{key:1},{default:u(()=>[l(G,null,{default:u(()=>[l(V,{cols:"12",md:"5"},{default:u(()=>[l(w,{modelValue:n(d),"onUpdate:modelValue":e[0]||(e[0]=r=>C(d)?d.value=r:null),label:"Barcode",density:"compact",variant:"outlined","error-messages":n(p),onInput:e[1]||(e[1]=r=>p.value=[])},null,8,["modelValue","error-messages"])]),_:1}),l(V,{cols:"12",md:"5"},{default:u(()=>[l(w,{modelValue:n(m),"onUpdate:modelValue":e[2]||(e[2]=r=>C(m)?m.value=r:null),label:"Количество",density:"compact",variant:"outlined","append-icon":"mdi-plus","prepend-icon":"mdi-minus","error-messages":n(i),onInput:e[3]||(e[3]=r=>i.value=[]),"onClick:prepend":e[4]||(e[4]=r=>m.value--),"onClick:append":e[5]||(e[5]=r=>m.value++)},null,8,["modelValue","error-messages"])]),_:1}),l(V,{cols:"12",md:"2"},{default:u(()=>[l(L,{color:"primary",disabled:!n(d),onClick:B},{default:u(()=>e[7]||(e[7]=[y(" Добавить ")])),_:1},8,["disabled"])]),_:1})]),_:1}),l(Q,{headers:x,items:n(s).goods,"row-props":R},null,8,["items"])]),_:1})):N("",!0)]),_:1})}}});export{pe as default};
