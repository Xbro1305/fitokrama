import{_ as A}from"./D72RvGjE.js";import{u as F}from"./B83tnpwP.js";import{d as P,C as Q,D as H,r as f,E as k,F as b,A as n,q as L,t as _,z as u,B as y,G as m,y as O,H as q,V as h,I as C,J as z,K as G,L as w}from"./CD-ciyMC.js";import{k as J}from"./CfZuxCf1.js";import{V as K,a as E,b as T}from"./S1xGE2Sl.js";import{V as I,a as Y}from"./V7KghpKn.js";import{V as j}from"./D2o8XtCw.js";import"./Dy0dx93s.js";import"./D2qL_eWx.js";import"./tHn_lS1N.js";import"./BJOK9706.js";import"./BT2HD4FG.js";const ie=P({__name:"assembly_order",setup(M){F({title:"Сборка заказа"});const{showError:c,showSuccess:v}=Q(),{email:g,password:V}=H(),N=L().public.backendUrl,l=f(null),d=f(""),o=f(1),p=f([]),i=f([]);k(p,()=>{setTimeout(()=>{p.value.length>0&&(p.value=[])},1e3)}),k(i,()=>{setTimeout(()=>{i.value.length>0&&(i.value=[])},1e3)});const x=[{title:"Артикул",key:"good_art"},{title:"Barcode",key:"barcode"},{title:"Название",key:"name"},{title:"Количество",key:"qty"},{title:"Собрано",key:"qty_as"}],S=async s=>{if(s.split("/")[0]!=="002-"||!s.split("/")[1]||s.split("/")[1].length!==6){c("Введите QR-код с листа для сборки");return}const{data:e,error:t}=await w(`${N}/order_details.php`,{method:"POST",body:{staff_login:g,staff_password:V,number:s.split("/")[1]}},"$enA4Lu5IYl");e.value.order?(l.value=e.value.order,l.value.goods.forEach(r=>{Number.parseInt(r.qty_as)!==0&&c("Заказ содержит уже отсканированные товары, однако их необходимо отсканировать снова")})):e.value.error?c(e.value.error):t&&c("Ошибка соединения с сервером")},B=s=>new Promise(e=>setTimeout(e,s)),$=async()=>{let s=!1;if(l.value.goods.forEach(t=>{t.barcode===d.value&&(s=!0)}),!s){p.value=["Лишний товар!"];return}if(Number.parseInt(o.value)<1){i.value=["Количество меньше нуля!"];return}l.value.goods.forEach(t=>{t.barcode===d.value&&(Number.parseInt(t.qty_as)+Number.parseInt(o.value)>Number.parseInt(t.qty)?i.value=["Лишний товар!"]:t.qty_as=Number.parseInt(t.qty_as)+Number.parseInt(o.value))});let e=!0;if(l.value.goods.forEach(t=>{Number.parseInt(t.qty_as)<Number.parseInt(t.qty)&&(e=!1)}),e){v("Заказ собран!");const t=[];l.value.goods.forEach(a=>{t.push({good_art:a.good_art,qty_as:a.qty_as})});const{data:r}=await w(`${N}/order_assembled.php`,{method:"POST",body:{staff_login:g,staff_password:V,order_number:l.value.number,goods:t}},"$9Wv8IUDWpt");if(r.value.message&&v(r.value.message),r.value.error&&v(r.value.error),r.value.html_for_print){const a=window.open("","_blank");a==null||a.document.write(r.value.html_for_print),B(200).then(()=>{a==null||a.document.close(),a==null||a.focus(),a==null||a.print()})}}},D=s=>{if(Number.parseInt(s.item.qty)===Number.parseInt(s.item.qty_as))return{class:"bg-green"}},R=()=>{Number.parseInt(o.value)<999&&(o.value=Number.parseInt(o.value)+1)},U=()=>{Number.parseInt(o.value)>1&&(o.value=Number.parseInt(o.value)-1)};return(s,e)=>{const t=A;return _(),b(K,null,{default:n(()=>[u(E,null,{default:n(()=>e[4]||(e[4]=[y(" Сборка заказа ")])),_:1}),u(T,null,{default:n(()=>[u(t,{onCodeScanned:S})]),_:1}),m(l)?(_(),b(E,{key:0},{default:n(()=>[y(" №"+O(m(l).number),1)]),_:1})):q("",!0),m(l)?(_(),b(T,{key:1},{default:n(()=>[u(Y,null,{default:n(()=>[u(I,{cols:"12",md:"5"},{default:n(()=>[u(h,{modelValue:m(d),"onUpdate:modelValue":e[0]||(e[0]=r=>C(d)?d.value=r:null),label:"Barcode",density:"compact",variant:"outlined","error-messages":m(p),onInput:e[1]||(e[1]=r=>p.value=[])},null,8,["modelValue","error-messages"])]),_:1}),u(I,{cols:"12",md:"5"},{default:n(()=>[z(u(h,{modelValue:m(o),"onUpdate:modelValue":e[2]||(e[2]=r=>C(o)?o.value=r:null),label:"Количество",density:"compact",variant:"outlined","append-icon":"mdi-plus","prepend-icon":"mdi-minus","error-messages":m(i),onInput:e[3]||(e[3]=r=>i.value=[]),"onClick:prepend":U,"onClick:append":R},null,8,["modelValue","error-messages"]),[[m(J),"###"]])]),_:1}),u(I,{cols:"12",md:"2"},{default:n(()=>[u(G,{color:"primary",disabled:!m(d),onClick:$},{default:n(()=>e[5]||(e[5]=[y(" Добавить ")])),_:1},8,["disabled"])]),_:1})]),_:1}),u(j,{headers:x,items:m(l).goods,"row-props":D},null,8,["items"])]),_:1})):q("",!0)]),_:1})}}});export{ie as default};
